5d4
< #include <semaphore.h>
14a14,15
> #include <dispatch/dispatch.h>
> 
82c83
< sem_t MSGNEW, MSGGOT;
---
> dispatch_semaphore_t  MSGNEW, MSGGOT;
406,408c407
< 		do; while (((res=sem_wait(&MSGNEW))) && (errno==EINTR));
< 		if (res)
< 			die("sd9p: sem_wait MSGNEW: %s", strerr(errno));
---
> 		dispatch_semaphore_wait(MSGNEW, DISPATCH_TIME_FOREVER);
416,417c415
< 		if (sem_post(&MSGGOT))
< 			die("sd9p: sem_post MSGGOT: %s", strerr(errno));
---
> 		dispatch_semaphore_signal(MSGGOT);
533c531
< 			fd = open(aname, O_DIRECTORY|O_CLOEXEC|O_SEARCH);
---
> 			fd = open(aname, O_DIRECTORY|O_CLOEXEC|O_RDONLY);
659c657
< 				int tmp = openat(pfd, newpfdname, O_DIRECTORY|O_CLOEXEC|O_SEARCH);
---
> 				int tmp = openat(pfd, newpfdname, O_DIRECTORY|O_CLOEXEC);
697c695
< 					tmp = openat(pfd, wnames[nwqid], O_DIRECTORY|O_CLOEXEC|O_SEARCH);
---
> 					tmp = openat(pfd, wnames[nwqid], O_DIRECTORY|O_CLOEXEC);
825,828c823,826
< 	if (sem_init(&MSGNEW, 0, 0))
< 		die("sd9p: sem_init MSGNEW: %s", strerror(errno));
< 	if (sem_init(&MSGGOT, 0, 0))
< 		die("sd9p: sem_init MSGGOT: %s", strerror(errno));
---
> 	if (!((MSGNEW=dispatch_semaphore_create(0))))
> 		die("sd9p: dispatch_semaphore_create MSGNEW: not enough memory");
> 	if (!((MSGGOT=dispatch_semaphore_create(0))))
> 		die("sd9p: dispatch_semaphore_create MSGGOT: not enough memory");
983,987c981,982
< 			if (sem_post(&MSGNEW))
< 				die("sd9p: sem_post MSGNEW: %s", strerr(errno));
< 			do; while (((res=sem_wait(&MSGGOT))) && (errno==EINTR));
< 			if (res)
< 				die("sd9p: sem_wait MSGGOT: %s", strerr(errno));
---
> 			dispatch_semaphore_signal(MSGNEW);
> 			dispatch_semaphore_wait(MSGGOT, DISPATCH_TIME_FOREVER);
